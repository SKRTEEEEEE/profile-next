name: üëÅÔ∏è‚Äçüó®Ô∏è Playwright Tests
on:
  pull_request:
    branches: [ main, master, buildn ]
  push:
    branches: [ main ]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
    # Checkout con fetch-depth completo para git operations
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Reset CI artifacts üßπ
      run: |
        rm -rf docs/test-results docs/coverage .nyc_output || true
        mkdir -p docs/test-results docs/coverage

    # Setup Node.js con cach√© para dependencias
    - uses: actions/setup-node@v6
      with:
        node-version: lts/*
        cache: 'npm'

    # Install dependencies (usa cach√© si est√° disponible)
    - name: Install dependencies
      run: npm ci
      env:
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

    # Cach√© de Playwright browsers
    - name: Get Playwright version
      id: playwright-version
      run: echo "PLAYWRIGHT_VERSION=$(node -e "console.log(require('./package-lock.json').packages['node_modules/@playwright/test'].version)")" >> $GITHUB_OUTPUT

    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: ~/.cache/ms-playwright
        key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.PLAYWRIGHT_VERSION }}

    - name: Install Playwright Browsers
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: npx playwright install --with-deps

    - name: Install Playwright dependencies only
      if: steps.playwright-cache.outputs.cache-hit == 'true'
      run: npx playwright install-deps

    # Build Next.js (si es necesario para producci√≥n)
    # NOTA: playwright.config.ts usa 'npm run dev' en CI (m√°s r√°pido)
    # El webServer se gestiona autom√°ticamente por Playwright
    
    # Run Playwright tests con coverage
    # webServer configurado en playwright.config.ts inicia el servidor autom√°ticamente
    - name: Run Playwright tests with NYC coverage üé≠
      run: npm run pw:cov
      continue-on-error: false
      env:
        CI: true

    - name: Ensure coverage summary
      if: always()
      run: npx nyc report --reporter=json-summary --report-dir=docs/coverage/playwright

    # Parse coverage results
    - name: Parse coverage data
      id: coverage
      if: always()
      run: |
        SUMMARY_PATH="./docs/coverage/playwright/coverage-summary.json"
        if [ -f "$SUMMARY_PATH" ]; then
          STATEMENTS=$(node -e "console.log(require('${SUMMARY_PATH}').total.statements.pct)")
          BRANCHES=$(node -e "console.log(require('${SUMMARY_PATH}').total.branches.pct)")
          FUNCTIONS=$(node -e "console.log(require('${SUMMARY_PATH}').total.functions.pct)")
          LINES=$(node -e "console.log(require('${SUMMARY_PATH}').total.lines.pct)")
          
          echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
          echo "lines=$LINES" >> $GITHUB_OUTPUT
          
          echo "Coverage: Statements $STATEMENTS% | Branches $BRANCHES% | Functions $FUNCTIONS% | Lines $LINES%"
        else
          echo "Coverage file not found"
          echo "statements=0" >> $GITHUB_OUTPUT
          echo "branches=0" >> $GITHUB_OUTPUT
          echo "functions=0" >> $GITHUB_OUTPUT
          echo "lines=0" >> $GITHUB_OUTPUT
        fi

    - name: Create coverage badges üèÖ
      if: github.ref == 'refs/heads/main' && steps.coverage.outputs.statements != '0'
      run: |
        mkdir -p .github/badges

        get_color() {
          local value=$(echo "$1" | awk '{printf "%.0f", $1}')
          if [ "$value" -ge 80 ]; then
            echo "brightgreen"
          elif [ "$value" -ge 40 ]; then
            echo "orange"
          elif [ "$value" -ge 10 ]; then
            echo "darkorange"
          else
            echo "red"
          fi
        }

        STATEMENTS_COLOR=$(get_color "${{ steps.coverage.outputs.statements }}")
        BRANCHES_COLOR=$(get_color "${{ steps.coverage.outputs.branches }}")
        FUNCTIONS_COLOR=$(get_color "${{ steps.coverage.outputs.functions }}")
        LINES_COLOR=$(get_color "${{ steps.coverage.outputs.lines }}")

        cat > .github/badges/coverage-statements.json << EOF
        {
          "schemaVersion": 1,
          "label": "statements",
          "message": "${{ steps.coverage.outputs.statements }}%",
          "color": "${STATEMENTS_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/coverage-branches.json << EOF
        {
          "schemaVersion": 1,
          "label": "branches",
          "message": "${{ steps.coverage.outputs.branches }}%",
          "color": "${BRANCHES_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/coverage-functions.json << EOF
        {
          "schemaVersion": 1,
          "label": "functions",
          "message": "${{ steps.coverage.outputs.functions }}%",
          "color": "${FUNCTIONS_COLOR}",
          "style": "flat-square"
        }
        EOF

        cat > .github/badges/coverage-lines.json << EOF
        {
          "schemaVersion": 1,
          "label": "lines",
          "message": "${{ steps.coverage.outputs.lines }}%",
          "color": "${LINES_COLOR}",
          "style": "flat-square"
        }
        EOF

    - name: Commit coverage badges
      if: github.ref == 'refs/heads/main' && steps.coverage.outputs.statements != '0'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Check if there are changes
        if [ -n "$(git status --porcelain .github/badges/*.json 2>/dev/null)" ]; then
          git add .github/badges/*.json
          git commit -m "chore: update coverage badges [skip ci]"
          git push
          echo "‚úÖ Coverage badges updated"
        else
          echo "‚ÑπÔ∏è No badge changes to commit"
        fi

    # README already points to shields endpoints; no automatic edits needed

    # Upload test report
    - uses: actions/upload-artifact@v5
      if: always()
      with:
        name: playwright-report
        path: docs/test-results/
        retention-days: 30
    
    # Upload coverage report
    - uses: actions/upload-artifact@v5
      if: always()
      with:
        name: coverage-report
        path: docs/coverage/
        retention-days: 30
    
    # Comment PR con resultados
    - name: Comment PR with coverage
      if: github.event_name == 'pull_request' && steps.coverage.outputs.statements != '0'
      uses: actions/github-script@v7
      with:
        script: |
          const statements = '${{ steps.coverage.outputs.statements }}';
          const branches = '${{ steps.coverage.outputs.branches }}';
          const functions = '${{ steps.coverage.outputs.functions }}';
          const lines = '${{ steps.coverage.outputs.lines }}';
          
          const body = `## üìä Test Coverage Results
          
          | Metric | Coverage |
          |--------|----------|
          | **Statements** | ${statements}% |
          | **Branches** | ${branches}% |
          | **Functions** | ${functions}% |
          | **Lines** | ${lines}% |
          
          [View full report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
